# =============================================================================
# nginx.conf — DSA Elements Summons PWA
# Serves a Vite-built React/TypeScript PWA with full PWA support
# =============================================================================

# Run as nginx user (set by base image)
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
    multi_accept        on;
    use                 epoll;
}

http {
    # -------------------------------------------------------------------------
    # MIME types
    # -------------------------------------------------------------------------
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Explicit overrides / additions for PWA-relevant types
    types {
        application/manifest+json          webmanifest;
        text/cache-manifest                appcache;
        image/svg+xml                      svg svgz;
        image/x-icon                       ico;
        image/webp                         webp;
        image/avif                         avif;
        font/woff                          woff;
        font/woff2                         woff2;
        application/javascript             js mjs;
        text/javascript                    cjs;
    }

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    # -------------------------------------------------------------------------
    # Performance
    # -------------------------------------------------------------------------
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    server_tokens       off;   # Do not expose nginx version

    # -------------------------------------------------------------------------
    # Gzip compression
    # -------------------------------------------------------------------------
    gzip                on;
    gzip_vary           on;
    gzip_proxied        any;
    gzip_comp_level     6;
    gzip_buffers        16 8k;
    gzip_http_version   1.1;
    gzip_min_length     256;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/cache-manifest
        application/javascript
        application/x-javascript
        application/json
        application/manifest+json
        application/xml
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2
        application/font-woff
        application/font-woff2;

    # -------------------------------------------------------------------------
    # Server block
    # -------------------------------------------------------------------------
    server {
        listen       80;
        listen  [::]:80;
        http2         on;            # HTTP/2 ready (actual TLS termination is
                                     # handled by the upstream reverse proxy)
        server_name   _;

        root  /usr/share/nginx/html;
        index index.html;

        # Maximum upload size (not normally needed for a read-only PWA but safe)
        client_max_body_size 10m;

        # ------------------------------------------------------------------
        # Security headers
        # ------------------------------------------------------------------
        add_header X-Content-Type-Options   "nosniff"                          always;
        add_header X-Frame-Options          "SAMEORIGIN"                       always;
        add_header X-XSS-Protection         "1; mode=block"                    always;
        add_header Referrer-Policy          "strict-origin-when-cross-origin"  always;
        add_header Permissions-Policy       "geolocation=(), microphone=(), camera=()" always;
        # Content-Security-Policy — adjust nonce/hash if you use inline scripts
        add_header Content-Security-Policy
            "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; manifest-src 'self'; worker-src 'self';"
            always;

        # ------------------------------------------------------------------
        # Service Worker — must NEVER be cached by the browser
        # so updates are picked up immediately
        # ------------------------------------------------------------------
        location = /sw.js {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma        "no-cache"                            always;
            add_header Expires       "0"                                   always;
            # Repeat security headers (add_header resets in nested blocks)
            add_header X-Content-Type-Options  "nosniff"       always;
            add_header X-Frame-Options         "SAMEORIGIN"    always;
            try_files $uri =404;
        }

        # Also handle the workbox-generated service worker if named differently
        location ~* ^/workbox-.*\.js$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma        "no-cache"                            always;
            add_header Expires       "0"                                   always;
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # Web App Manifest
        # ------------------------------------------------------------------
        location = /manifest.webmanifest {
            add_header Cache-Control "no-cache" always;
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        location = /manifest.json {
            add_header Cache-Control "no-cache" always;
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # HTML entry point — no-cache so the user always gets the latest shell
        # ------------------------------------------------------------------
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma        "no-cache"                            always;
            add_header Expires       "0"                                   always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options        "SAMEORIGIN" always;
        }

        # ------------------------------------------------------------------
        # Hashed assets (JS / CSS produced by Vite with content hash in name)
        # Pattern: /assets/index-AbCd1234.js  /assets/index-AbCd1234.css
        # Safe to cache for 1 year because the hash changes on every build.
        # ------------------------------------------------------------------
        location ~* ^/assets/.*\.[0-9a-f]{8,}\.(js|mjs|css)$ {
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header X-Content-Type-Options "nosniff" always;
            access_log off;
            try_files $uri =404;
        }

        # Generic JS / CSS without hash in filename (moderate cache)
        location ~* \.(js|mjs|cjs|css)$ {
            add_header Cache-Control "public, max-age=86400" always;   # 1 day
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # Fonts — long-lived, content-addressed by convention
        # ------------------------------------------------------------------
        location ~* \.(woff|woff2|ttf|otf|eot)$ {
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header Access-Control-Allow-Origin "*";
            access_log off;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # Icons and images — moderate cache (1 week)
        # ------------------------------------------------------------------
        location ~* \.(png|jpg|jpeg|gif|ico|svg|svgz|webp|avif|bmp)$ {
            add_header Cache-Control "public, max-age=604800" always;   # 7 days
            add_header X-Content-Type-Options "nosniff" always;
            access_log off;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # Vite's registerSW / workbox precache manifests
        # ------------------------------------------------------------------
        location ~* ^/registerSW\.js$ {
            add_header Cache-Control "no-cache" always;
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # ------------------------------------------------------------------
        # SPA fallback — every unknown path returns index.html so that
        # React Router can handle client-side routing.
        # ------------------------------------------------------------------
        location / {
            # Serve the file if it exists on disk; fall back to index.html
            try_files $uri $uri/ /index.html;

            # index.html must not be cached
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma        "no-cache"                            always;
            add_header Expires       "0"                                   always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options        "SAMEORIGIN" always;
        }

        # ------------------------------------------------------------------
        # Health check endpoint (used by Docker / load balancer)
        # ------------------------------------------------------------------
        location = /healthz {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # ------------------------------------------------------------------
        # Block hidden files (e.g. .git, .env)
        # ------------------------------------------------------------------
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}
